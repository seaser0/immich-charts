## This chart relies on the common library chart from bjw-s
## You can find it at https://github.com/bjw-s-labs/helm-charts/tree/common-4.3.0/charts/library/common
## Refer there for more detail about the supported values

# These entries are shared between all the Immich components

controllers:
  main:
    containers:
      main:
        image:
          tag: v2.3.1
        env:
          REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
          IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
          # Add the env vars to connect to your database here.

          # ===========================
          # External CNPG wiring
          # ===========================
          DB_HOSTNAME:
            valueFrom:
              secretKeyRef:
                name: immich-db
                key: DB_HOST
          DB_PORT:
            valueFrom:
              secretKeyRef:
                name: immich-db
                key: DB_PORT
          DB_USERNAME:
            valueFrom:
              secretKeyRef:
                name: immich-db
                key: DB_USERNAME
          DB_DATABASE_NAME:
            valueFrom:
              secretKeyRef:
                name: immich-db
                key: DB_NAME
          DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: immich-db
                key: DB_PASSWORD


immich:
  metrics:
    # Enabling this will create the service monitors needed to monitor immich with the prometheus operator
    enabled: true
  persistence:
    library:
      existingClaim: immich-data-pvc-prd

  resources:
    requests:
      cpu: 600m
      memory: 1.5Gi
    limits:
      cpu: 1500m
      memory: 4Gi

  # configuration is immich-config.json converted to yaml
  # ref: https://immich.app/docs/install/config-file/
  #
  configuration: {}

# Dependencies
valkey:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: docker.io/valkey/valkey
            tag: 9.0-alpine@sha256:b4ee67d73e00393e712accc72cfd7003b87d0fcd63f0eba798b23251bfc9c394
            pullPolicy: IfNotPresent
  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      size: 1Gi
      accessMode: ReadWriteOnce
      storageClass: nfs-csi

# Immich components
server:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 8
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 75
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 300
    scaleDown:
      stabilizationWindowSeconds: 900

  controllers:
    main:
      strategy: RollingUpdate
      extraVolumes:
        - name: ext-lightroom-pvc
          persistentVolumeClaim:
            claimName: immich-lightroom-pvc
        - name: ext-mirjam-pvc
          persistentVolumeClaim:
            claimName: immich-fotos-mirjam-pvc

      extraVolumeMounts:
        - name: ext-lightroom-pvc
          mountPath: /external/lightroom
          readOnly: false
        - name: ext-mirjam-pvc
          mountPath: /external/mirjam_fotos
          readOnly: false
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-server
            pullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 600m
              memory: 1.5Gi
            limits:
              cpu: 1500m
              memory: 4Gi

  ingress:
      main:
        enabled: true               # ‚Üê the only switch that makes the resource appear
        className: nginx  
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
          nginx.ingress.kubernetes.io/backend-protocol: HTTP
          # proxy-body-size is set to 0 to remove the body limit on file uploads
          nginx.ingress.kubernetes.io/proxy-body-size: "0"
        hosts:
          - host: immich.nevit.ch
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - immich.nevit.ch
            secretName: immich-secret-tls


machine-learning:
  enabled: true

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 3500m
      memory: 3Gi
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-machine-learning
            pullPolicy: IfNotPresent
          env:
            TRANSFORMERS_CACHE: /cache
            HF_XET_CACHE: /cache/huggingface-xet
            MPLCONFIGDIR: /cache/matplotlib-config
  persistence:
    cache:
      enabled: true
      size: 10Gi
      # Optional: Set this to persistentVolumeClaim to avoid downloading the ML models every start.
      type: persistentVolumeClaim
      accessMode: ReadWriteMany
      storageClass: nfs-csi

